# Basketeer V4 极简架构图

## 🏗️ 整体架构概览

```
┌─────────────────────────────────────────────────────────────────────┐
│                        Basketeer V4 生态系统                          │
└─────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────┐
│                          用户交互层                                    │
├─────────────────────────────────────────────────────────────────────┤
│  👤 用户                                                            │
│   ├── depositSingle() ──────────┐                                   │
│   ├── withdraw() ───────────────┼── 直接调用策略合约                    │
│   └── basketUsd() ─────────────┘                                    │
└─────────────────────────────────────────────────────────────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────────┐
│                         策略合约层                                     │
├─────────────────────────────────────────────────────────────────────┤
│  📊 BasketeerV4 (Strategy Contract)                                 │
│   ├── 策略参数: tokens[], weights[], USD                              │
│   ├── 份额管理: BasketShares                                         │
│   ├── 模块地址: oracleModule, pricingModule, tradingModule           │
│   └── 核心逻辑: deposit, withdraw, 净值计算                           │
└─────────────────────────────────────────────────────────────────────┘
                                  │
                                  ▼ (接口调用)
┌─────────────────────────────────────────────────────────────────────┐
│                         模块合约层                                     │
├─────────────────────────────────────────────────────────────────────┤
│  🔮 OracleModuleV2        💰 PricingModuleV2        🔄 TradingModuleV2│
│   ├── TWAP管理             ├── 代币定价              ├── Uniswap交易   │
│   ├── 价格更新             ├── 净值计算              ├── 按权重分配     │
│   └── 预言机数据           └── UQ112x112库          └── 等比例提取     │
└─────────────────────────────────────────────────────────────────────┘
                                  │
                                  ▼ (依赖外部协议)
┌─────────────────────────────────────────────────────────────────────┐
│                        外部协议层                                      │
├─────────────────────────────────────────────────────────────────────┤
│  🦄 Uniswap V2                              💎 ERC20 代币              │
│   ├── 交易对 (Pairs)                         ├── WBTC, WETH, DAI      │
│   ├── 路由器 (Router)                        ├── 18位小数              │
│   └── TWAP 数据源                           └── 标准接口              │
└─────────────────────────────────────────────────────────────────────┘
```

## 📋 管理合约层

```
┌─────────────────────────────────────────────────────────────────────┐
│                         管理合约层                                     │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  📚 BasketeerRegistry          🏭 BasketeerDeployer                  │
│   ├── 策略注册表                 ├── 策略部署工厂                        │
│   ├── 创建者映射                 ├── 模块地址配置                        │
│   ├── 策略验证                   └── 新策略创建                        │
│   └── 批量查询                                                       │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

## 🔄 部署流程图

```
🚀 部署流程 (一次性)
├── 1️⃣ 部署模块合约
│   ├── OracleModuleV2.deploy()
│   ├── PricingModuleV2.deploy(oracle)
│   └── TradingModuleV2.deploy(router)
│
├── 2️⃣ 部署管理合约
│   ├── BasketeerRegistry.deploy()
│   └── BasketeerDeployer.deploy(modules...)
│
└── ✅ 基础设施完成

🎯 策略创建流程 (重复)
├── 1️⃣ 调用部署器
│   └── deployer.deployStrategy(tokens, weights, ...)
│
├── 2️⃣ 注册策略
│   └── registry.registerStrategy(strategyAddress)
│
└── ✅ 策略可用
```

## 💡 模块通信图

```
BasketeerV4 Strategy
        │
        ├── IOracleModule ──────► OracleModuleV2
        │    ├── initializeUsdPair()
        │    ├── updateOracle()
        │    └── getPrice()
        │
        ├── IPricingModule ─────► PricingModuleV2
        │    ├── quoteTokenInUSD()
        │    └── calculateBasketValue()
        │
        └── ITradingModule ─────► TradingModuleV2
             ├── executeSwaps()
             └── withdrawProportional()
```

## 📊 数据流图

```
用户存款流程:
┌─────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│用户  │───▶│策略合约      │───▶│交易模块      │───▶│Uniswap V2   │
│存款  │    │计算份额      │    │执行兑换      │    │实际交易      │
└─────┘    └─────────────┘    └─────────────┘    └─────────────┘
                  │                   │
                  ▼                   ▼
           ┌─────────────┐    ┌─────────────┐
           │定价模块      │    │预言机模块    │
           │计算净值      │    │获取TWAP     │
           └─────────────┘    └─────────────┘

用户提款流程:
┌─────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│用户  │───▶│策略合约      │───▶│交易模块      │───▶│ERC20代币    │
│提款  │    │销毁份额      │    │等比例转账    │    │直接转账      │
└─────┘    └─────────────┘    └─────────────┘    └─────────────┘
```

## 🎯 V4架构优势

### ✅ 合约大小优化
- **模块合约**: 每个 < 5KB，功能单一
- **策略合约**: < 8KB，只包含协调逻辑
- **管理合约**: 注册表 < 2KB，部署器 < 3KB

### ✅ 成本优化
- **一次部署**: 模块合约部署一次，所有策略复用
- **低创建成本**: 新策略只需部署轻量主合约
- **无重复代码**: 避免在每个策略中重复模块代码

### ✅ 可维护性
- **职责分离**: 每个合约功能明确
- **独立升级**: 可以部署新版本模块
- **易于测试**: 每个模块可以独立测试
- **代码复用**: 模块在所有策略间共享

### ✅ 扩展性
- **新模块**: 可以轻松添加新功能模块
- **新策略**: 创建成本极低
- **新协议**: 可以支持更多DEX和代币协议

## 📋 文件对应关系

```
架构组件 ────────────────── 对应文件
├── OracleModuleV2 ────── modules/OracleModuleV2.sol
├── PricingModuleV2 ───── modules/PricingModuleV2.sol
├── TradingModuleV2 ───── modules/TradingModuleV2.sol
├── BasketeerV4 ───────── BasketeerV4.sol
├── BasketeerRegistry ─── BasketeerRegistry.sol
├── BasketeerDeployer ─── BasketeerDeployer.sol
├── IModules ──────────── interfaces/IModules.sol
└── 部署脚本 ──────────── scripts/deploy-ultra-minimal.js
```

这个V4架构通过极致的模块化设计，将每个合约的大小压缩到最小，同时保持完整的功能性！
