# Basketeer V3 Architecture

## ğŸ—ï¸ æ¶æ„æ¦‚è¿°

Basketeer V3 é‡‡ç”¨æ¨¡å—åŒ–æ¶æ„è®¾è®¡ï¼Œè§£å†³äº†åˆçº¦å­—èŠ‚ç è¿‡å¤§çš„é—®é¢˜ï¼Œæä¾›äº†æ›´å¥½çš„å¯æ‰©å±•æ€§å’Œç»´æŠ¤æ€§ã€‚

### ğŸ“ æ–‡ä»¶ç»“æ„

```
contracts/src/
â”œâ”€â”€ interfaces/           # æ¥å£å®šä¹‰
â”‚   â”œâ”€â”€ IERC20.sol       # ERC20æ¥å£
â”‚   â”œâ”€â”€ IModules.sol     # æ¨¡å—æ¥å£å®šä¹‰
â”‚   â””â”€â”€ IUniswap.sol     # Uniswap V2æ¥å£
â”œâ”€â”€ base/                # åŸºç¡€åˆçº¦
â”‚   â””â”€â”€ BasketShares.sol # ä»½é¢ä»£å¸åˆçº¦
â”œâ”€â”€ libraries/           # å·¥å…·åº“
â”‚   â”œâ”€â”€ UQ112x112.sol    # å›ºå®šç‚¹æ•°å­¦åº“
â”‚   â””â”€â”€ V2Oracle.sol     # V2é¢„è¨€æœºè¾…åŠ©åº“
â”œâ”€â”€ modules/             # ç‹¬ç«‹æ¨¡å—
â”‚   â”œâ”€â”€ OracleModuleV2.sol  # TWAPé¢„è¨€æœºæ¨¡å—
â”‚   â”œâ”€â”€ PricingModuleV2.sol # å®šä»·è®¡ç®—æ¨¡å—
â”‚   â””â”€â”€ TradingModuleV2.sol # äº¤æ˜“æ‰§è¡Œæ¨¡å—
â”œâ”€â”€ BasketeerV3.sol      # ä¸»ç­–ç•¥åˆçº¦
â””â”€â”€ BasketeerFactoryV3.sol # å·¥å‚åˆçº¦

scripts/
â”œâ”€â”€ deploy-v3.js         # V3æ¶æ„éƒ¨ç½²è„šæœ¬
â””â”€â”€ create-strategy-v3.js # ç­–ç•¥åˆ›å»ºè„šæœ¬
```

## ğŸ”§ æ¨¡å—è¯´æ˜

### 1. ç‹¬ç«‹æ¨¡å—åˆçº¦
- **OracleModuleV2**: ç®¡ç†Uniswap V2 TWAPä»·æ ¼æ›´æ–°
- **PricingModuleV2**: åŸºäºé¢„è¨€æœºè¿›è¡Œä»£å¸å®šä»·å’Œå‡€å€¼è®¡ç®—
- **TradingModuleV2**: å¤„ç†Uniswapäº¤æ˜“å’Œæå–æ“ä½œ

### 2. ä¸»åˆçº¦
- **BasketeerV3**: ç­–ç•¥ä¸»åˆçº¦ï¼Œé€šè¿‡æ¥å£è°ƒç”¨æ¨¡å—åŠŸèƒ½
- **BasketeerFactoryV3**: å·¥å‚åˆçº¦ï¼Œæ¥å—é¢„éƒ¨ç½²æ¨¡å—åœ°å€åˆ›å»ºç­–ç•¥

### 3. æ¥å£å®šä¹‰
- **IModules.sol**: å®šä¹‰æ‰€æœ‰æ¨¡å—çš„æ ‡å‡†æ¥å£

## ğŸš€ éƒ¨ç½²æµç¨‹

### ç¬¬ä¸€æ­¥ï¼šéƒ¨ç½²æ¨¡å—åˆçº¦
```bash
npx hardhat run scripts/deploy-v3.js --network <network>
```

è¿™ä¼šä¾æ¬¡éƒ¨ç½²ï¼š
1. OracleModuleV2 - ç‹¬ç«‹é¢„è¨€æœºæ¨¡å—
2. PricingModuleV2 - ç‹¬ç«‹å®šä»·æ¨¡å—
3. TradingModuleV2 - ç‹¬ç«‹äº¤æ˜“æ¨¡å—
4. BasketeerFactoryV3 - å·¥å‚åˆçº¦

### ç¬¬äºŒæ­¥ï¼šåˆ›å»ºç­–ç•¥
```bash
# ç¼–è¾‘ create-strategy-v3.js ä¸­çš„ FACTORY_ADDRESS
npx hardhat run scripts/create-strategy-v3.js --network <network>
```

## ğŸ’¡ æ¶æ„ä¼˜åŠ¿

### 1. è§£å†³åˆçº¦å¤§å°é™åˆ¶
- âœ… æ¯ä¸ªæ¨¡å—éƒ½å¾ˆå°ï¼Œé¿å…24KBé™åˆ¶
- âœ… ä¸»åˆçº¦åªåŒ…å«åè°ƒé€»è¾‘
- âœ… å¯ä»¥é¡ºåˆ©éƒ¨ç½²åˆ°ä»»ä½•ç½‘ç»œ

### 2. æˆæœ¬ä¼˜åŒ–
- âœ… æ¨¡å—åªéœ€éƒ¨ç½²ä¸€æ¬¡ï¼Œå¯è¢«å¤šä¸ªç­–ç•¥å¤ç”¨
- âœ… ç­–ç•¥åˆ›å»ºæˆæœ¬å¤§å¹…é™ä½
- âœ… æ›´é«˜æ•ˆçš„Gasä½¿ç”¨

### 3. å¯ç»´æŠ¤æ€§
- âœ… æ¨¡å—åŒ–è®¾è®¡ï¼ŒèŒè´£åˆ†ç¦»
- âœ… å¯ä»¥å•ç‹¬å‡çº§æ¨¡å—
- âœ… ä»£ç å¤ç”¨æ€§å¼º
- âœ… ä¾¿äºæµ‹è¯•å’Œè°ƒè¯•

### 4. å»ä¸­å¿ƒåŒ–
- âœ… æ— ç®¡ç†å‘˜åŠŸèƒ½
- âœ… å‚æ•°åœ¨æ„é€ æ—¶å›ºå®š
- âœ… å®Œå…¨å»ä¸­å¿ƒåŒ–è¿è¡Œ

## ğŸ“‹ ä½¿ç”¨ç¤ºä¾‹

### åˆ›å»ºç­–ç•¥
```javascript
const factory = await ethers.getContractAt("BasketeerFactoryV3", factoryAddress);

const strategy = await factory.createStrategy(
    tokens,      // ä»£å¸åœ°å€æ•°ç»„
    weights,     // æƒé‡æ•°ç»„ï¼ˆåŸºç‚¹ï¼‰
    name,        // ç­–ç•¥åç§°
    symbol,      // ç­–ç•¥ç¬¦å·
    usdToken,    // åŸºå‡†USDä»£å¸
    pairs        // Uniswap V2äº¤æ˜“å¯¹æ•°ç»„
);
```

### ç”¨æˆ·æ“ä½œ
```javascript
const strategy = await ethers.getContractAt("BasketeerV3", strategyAddress);

// å­˜æ¬¾
await strategy.depositSingle(tokenIn, amount, minOuts, paths, deadline);

// ææ¬¾
await strategy.withdraw(shares);

// æŸ¥è¯¢å‡€å€¼
const value = await strategy.basketUsd();
```

## ğŸ” æŠ€æœ¯ç‰¹ç‚¹

- **æ¥å£é©±åŠ¨**: ä¸»åˆçº¦é€šè¿‡æ¥å£è°ƒç”¨æ¨¡å—åŠŸèƒ½
- **æ¨¡å—å¤ç”¨**: å¤šä¸ªç­–ç•¥å¯ä»¥å…±äº«åŒä¸€å¥—æ¨¡å—
- **æ°”ä½“ä¼˜åŒ–**: æ¨¡å—è°ƒç”¨æ¯”å†…è”ä»£ç æ›´é«˜æ•ˆ
- **å‡çº§å‹å¥½**: å¯ä»¥éƒ¨ç½²æ–°ç‰ˆæœ¬æ¨¡å—è€Œä¸å½±å“ç°æœ‰ç­–ç•¥

è¿™ä¸ªV3æ¶æ„å®Œç¾è§£å†³äº†åˆçº¦å¤§å°é—®é¢˜ï¼ŒåŒæ—¶æä¾›äº†æ›´å¥½çš„æ¶æ„è®¾è®¡å’Œç”¨æˆ·ä½“éªŒï¼
